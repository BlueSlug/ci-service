
- defaults:
    name: idi-centos
    docker_username: inclusivedesign
    docker_image: centos
    git_repo: https://github.com/idi-ops/docker-centos.git
    build_timeout: 30
    email_recipient: ops-notifications@lists.inclusivedesign.ca
    jenkins_node: i-0027.tor1.inclusivedesign.ca

- project:
    name: idi-centos-7
    jenkins_tag: 7
    git_branch: master
    docker_tag: 7
    jobs:
      - docker-idi-centos-all

- project:
    name: idi-centos-latest
    jenkins_tag: latest
    git_branch: master
    docker_tag: latest
    jobs:
      - docker-idi-centos-all

- job-group:
    name: docker-idi-centos-all
    jobs:
      - docker-idi-centos-{jenkins_tag}
      - docker-idi-centos-{jenkins_tag}-build
      - docker-idi-centos-{jenkins_tag}-test
      - docker-idi-centos-{jenkins_tag}-release
      - docker-idi-centos-{jenkins_tag}-cleanup

- job-template:
    defaults: idi-centos
    name: docker-idi-centos-{jenkins_tag}
    description: 'Builds, tests and pushes the CentOS Docker image'
    project-type: multijob
    concurrent: false
    node: '{jenkins_node}'
    wrappers:
      - timeout:
          timeout: '{build_timeout}'
          abort: yes
    publishers:
      - email:
            recipients: '{email_recipient}'
    scm:
      - git:
          url: '{git_repo}'
          skip-tag: true
          branches:
            - '{git_branch}'
    triggers:
      - github
      - pollurl:
          cron: '0 2 * * *'
          urls:
            - url: 'https://github.com/docker-library/official-images/commits/master.atom'
              check-content:
                - xml:
                    - '/feed/updated'
    builders:
      - multijob:
          name: Cleanup
          condition: SUCCESSFUL
          projects:
            - name: docker-idi-centos-{jenkins_tag}-cleanup
              predefined-parameters: parent_workspace=$WORKSPACE
      - multijob:
          name: Build
          condition: SUCCESSFUL
          projects:
            - name: docker-idi-centos-{jenkins_tag}-build
              predefined-parameters: parent_workspace=$WORKSPACE
      - multijob:
          name: Test
          condition: SUCCESSFUL
          projects:
            - name: docker-idi-centos-{jenkins_tag}-test
              predefined-parameters: parent_workspace=$WORKSPACE
      - multijob:
          name: Publish
          condition: SUCCESSFUL
          projects:
            - name: docker-idi-centos-{jenkins_tag}-release
              predefined-parameters: parent_workspace=$WORKSPACE

- job-template:
    defaults: idi-centos
    name: docker-idi-centos-{jenkins_tag}-cleanup
    description: 'Removes build artifacts'
    node: '{jenkins_node}'
    workspace: $parent_workspace
    builders:
      - shell: docker rmi -f {docker_username}/{docker_image}:{docker_tag} || echo "docker rmi failed. image probably does not exist"

- job-template:
    defaults: idi-centos
    name: docker-idi-centos-{jenkins_tag}-build
    description: 'Builds Docker image'
    node: '{jenkins_node}'
    workspace: $parent_workspace
    builders:
      - shell: docker build --pull -t {docker_username}/{docker_image}:{docker_tag} .

- job-template:
    defaults: idi-centos
    name: docker-idi-centos-{jenkins_tag}-test
    description: 'Runs a test container'
    node: '{jenkins_node}'
    workspace: $parent_workspace
    builders:
      - shell: docker run --rm -i {docker_username}/{docker_image}:{docker_tag} /usr/bin/ansible -m debug -a "msg='OK'" localhost

# Tag operation is forced in case they've happened in the past from a previous build (no-op)
# Push is forced otherwise a prompt is displayed asking if really want to publish to public registry
- job-template:
    defaults: idi-centos
    name: docker-idi-centos-{jenkins_tag}-release
    description: 'Publishes to Docker Hub'
    node: '{jenkins_node}'
    workspace: $parent_workspace
    builders:
      - shell: docker push {docker_username}/{docker_image}:{docker_tag}
